# Журнал изменений

## v0.1.11 - 2026-02-11

### Улучшено

- Убрана проверка расширений файлов в `Send Message` для вложений (`image`/`video`/`audio`/`file`): нода больше не блокирует вложения по типу файла до запроса в Max API.

### Кому важно

- Пользователям, которые отправляют нестандартные форматы файлов через `Additional Fields → Attachments`.
- Пользователям workflow, где расширение файла может не совпадать со списком типовых форматов.

### Что проверить после обновления

- Отправить вложение с нестандартным расширением через `Binary Data`: нода должна выполнить upload без локальной ошибки про формат файла.
- Отправить вложение с нестандартным расширением по `URL`: нода должна выполнить upload без локальной ошибки про формат файла.
- Проверить обычную отправку типовых вложений (`image`, `video`, `audio`, `file`) в вашем основном сценарии.

## v0.1.9 - 2026-02-11

### Улучшено

- Исправлена отправка документов (`type: file`) в `Send Message`: при формировании вложения теперь используется `token`, а не `url` из upload-ответа.
- Убраны legacy-fallback ветки в обработке upload-ответа: используется только контрактный payload из актуального API.
- Исправлен повтор отправки при временной ошибке обработки вложения: теперь `Send Message` распознаёт `attachment.not.ready`, даже когда Max API возвращает ошибку в формате `response.data` (типичный формат для n8n/axios), и делает автоматический retry.

### Кому важно

- Пользователям, которые отправляют документы (`.pdf`, `.docx`, `.zip` и т.д.) через `Additional Fields → Attachments`.
- Пользователям сценариев с отправкой файла без текста.
- Пользователям, у которых при отправке файлов появлялся общий `400` без повторной попытки.

### Что проверить после обновления

- Отправить `type: file` из `Binary Data`: сообщение должно успешно уйти.
- Отправить `type: file` по `URL`: сообщение должно успешно уйти.
- В случае временной ошибки обработки файла (`attachment.not.ready`) проверить, что нода делает повторные попытки автоматически и сообщение всё же отправляется.
- Проверить, что отправка изображений (`type: image`) работает как раньше.

## v0.1.8 - 2026-02-11

### Улучшено

- В `Send Message` поле `Message Text` больше не обязательно, если добавлено хотя бы одно вложение. Теперь можно отправлять файл/медиа без текста.

### Кому важно

- Пользователям, которые отправляют в Max только файлы или медиа без подписи.
- Пользователям workflow, где текст формируется не всегда, а вложение обязательно.

### Что проверить после обновления

- В `Max` → `Send Message` отправить сообщение с вложением и пустым `Message Text`: сообщение должно успешно уйти.
- Проверить, что сценарий без текста и без вложений по-прежнему возвращает понятную ошибку валидации.
- Проверить обычную отправку текстового сообщения и отправку с `markdown`/`html` форматом.

## v0.1.7 - 2026-02-10

### Улучшено

- Отправка сообщений с медиа-вложениями теперь автоматически повторяется при временных ошибках обработки файла (`attachment.not.ready` / `errors.process.attachment.file.not.processed`), что снижает количество ложных падений workflow (`3a1bf51`).
- Для вложений после upload-шага теперь корректно используется payload из ответа (`token`, `url`, `photos`), а для видео/аудио добавлен fallback на token из `POST /uploads`, если upload endpoint не вернул валидный JSON (`3a1bf51`).
- В `Send Message` значение ID получателя `0` теперь явно отклоняется с подсказкой по полям из `Max Trigger`: `message.sender.user_id` для пользователя и `message.recipient.chat_id` для чата (`3a1bf51`).

### Сопровождение

- Обновлены правила ведения changelog: релизы описываются по тегам и включают операционные блоки для пользователей (`785ddb8`).

### Кому важно

- Пользователям, которые отправляют изображения, видео, аудио и файлы через `Max`.
- Пользователям `Max Trigger`-workflow, где ID получателя маппится из входящих событий.
- Мейнтейнерам, которые готовят релизные заметки.

### Что проверить после обновления

- Отправить тестовое сообщение с медиа-вложением и убедиться, что при временной ошибке обработки файл отправляется без ручного перезапуска.
- Проверить маппинг ID в workflow: для личных сообщений использовать `message.sender.user_id`, для чатов `message.recipient.chat_id`; значение `0` не использовать.
- Проверить отправку вложений из binary и по URL в вашем основном сценарии.

## v0.1.6 - 2026-02-10

### Добавлено

- Добавлена поддержка webhook URL с IDN-доменами: адрес перед подпиской приводится к Punycode (`748b129`). Это нужно для корректной TLS-валидации webhook URL в Max API.

### Улучшено

- Исправлен сценарий отправки файлов и изображений: вложения в проблемных кейсах снова отправляются (`1bc596c`).
- Добавлен fallback в plain text при ответе Max API `Some Markdown syntax is not supported...`, чтобы сообщение отправлялось даже при неподдерживаемой части Markdown-разметки (`1bc596c`).

### Для разработки

- Добавлен pre-commit запуск Prettier для staged-файлов (`1bc596c`).

### Кому важно

- Пользователям `Max Trigger` с webhook URL на IDN-доменах.
- Пользователям, у которых были сбои отправки файлов/изображений.
- Пользователям, у которых сообщения с Markdown периодически не отправлялись из-за ограничений Max API.

### Что проверить после обновления

- Если раньше trigger не активировался на IDN-домене, переактивировать workflow и проверить создание подписки.
- Проверить отправку файла и изображения в вашем типовом сценарии.
- Проверить сценарий с Markdown-сообщениями, которые раньше падали с ошибкой `Some Markdown syntax is not supported...`.

## v0.1.5 - 2026-02-09

### Улучшено

- Токен в API-запросах теперь передаётся в заголовке `Authorization`, а не в query-параметре URL (`f07ea20`). Это соответствует текущему формату авторизации Max API.

### Сопровождение

- Обновлены сообщения stale-бота для issues/PR (`da335f2`).
- Уточнена пользовательская документация в README (`d9fc4cc`).

### Кому важно

- Всем пользователям ноды, которые отправляют запросы к Max API через `Max`/`Max Trigger`.
- Пользователям с прокси/WAF или кастомным API-контуром, где фильтруются заголовки.

### Что проверить после обновления

- Убедиться, что в вашей инфраструктуре не блокируется заголовок `Authorization`.
- Если используется кастомный `baseUrl`, выполнить тестовую отправку сообщения и активацию trigger.

## v0.1.4 - 2025-07-23

### Добавлено

- В `Send Message` добавлена возможность отправлять reply на конкретное сообщение (`5eb09b6`).

### Кому важно

- Пользователям, которым нужны ответные сообщения в контексте конкретного `message_id`.

### Что проверить после обновления

- Проверить сценарий `Send Message` с заполненным `Reply to Message ID`.

## v0.1.3 - 2025-07-23

### Улучшено

- Расширена валидация ID: поддержаны отрицательные и нулевые значения там, где они допустимы (`4d7f4fd`).
- Улучшены тексты ошибок валидации ID (`4d7f4fd`).

### Кому важно

- Пользователям, работающим с ID, которые раньше отклонялись валидацией.

### Что проверить после обновления

- Повторно запустить workflow, где раньше была ошибка валидации ID.

## v0.1.2 - 2025-07-22

### Улучшено

- Скорректирована валидация Chat ID (с поддержкой неотрицательных значений) (`417e80e`).
- Улучшены тексты ошибок для Chat ID (`417e80e`).

### Кому важно

- Пользователям, у которых `Chat ID` отклонялся при отправке сообщения или чат-операциях.

### Что проверить после обновления

- Проверить операции, где используется `Chat ID` (`Send Message to Chat`, `Get Chat`, `Leave Chat`).

## v0.1.1 - 2025-07-22

### Добавлено

- Первый публичный релиз `n8n-nodes-max`.
- Добавлены `Max` и `Max Trigger` для исходящих действий и webhook-триггеров в Max.
- Добавлена поддержка вложений и inline-клавиатур.
- Добавлен скрипт для локальной проверки webhook через туннель (`9afc415`).

### Улучшено

- Добавлена валидация и метаданные в обработку webhook-событий (`b5dd5ee`).
- Удалены legacy/deprecated поля и структура событий выровнена с актуальной схемой API (`186e639`).
- Упрощена обработка событий и убраны устаревшие поля (`7fc9476`).

### Для разработки

- Добавлены интеграционные тесты и фикстуры для webhook-событий (`6d76a14`).

### Кому важно

- Всем новым пользователям ноды `n8n-nodes-max`.

### Что проверить после обновления

- Настроить `MaxApi` credentials.
- Выполнить тестовую отправку сообщения и тестовую активацию `Max Trigger`.
