# n8n-nodes-max

Нода для интеграции мессенджера Max с платформой автоматизации n8n.
<img width="518" height="429" alt="image" src="https://github.com/user-attachments/assets/577165bb-510f-4523-b898-76ea94dc0f2b" />

## Установка

### Для self-hosted n8n

1. Установите пакет через npm в директории n8n:

```bash
npm install n8n-nodes-max
```

2. Перезапустите n8n для загрузки новой ноды

### Для n8n Cloud

1. Откройте настройки вашего workspace
2. Перейдите в раздел "Community nodes"
3. Нажмите "Install a community node"
4. Введите `n8n-nodes-max` и нажмите "Install"

### Альтернативный способ (переменная окружения)

Добавьте пакет в переменную окружения:

```bash
export N8N_CUSTOM_EXTENSIONS=n8n-nodes-max
```

**Полезные ссылки:**

- [Официальная документация по установке community nodes](https://docs.n8n.io/integrations/community-nodes/installation/)
- [Руководство по self-hosted установке](https://docs.n8n.io/hosting/)

## Для разработки

- После `npm install` автоматически устанавливается Husky pre-commit hook.
- Перед коммитом запускается Prettier для staged исходников (`*.{ts,js,mjs,cjs,json,md,yml,yaml}`).

## Возможности

### Сообщения

- Отправка текстовых сообщений с форматированием
- Автоматический fallback в plain text при ошибке Max API о неподдерживаемом Markdown
- Редактирование и удаление сообщений
- Отправка файлов (изображения, видео, аудио, документы)
- В `Send Message` текст не обязателен, если отправляются вложения
- Payload вложения формируется из JSON-ответа upload-шага (`token`, `url`, `photos`)
- Автоматический ретрай отправки с медиа-вложением при временной ошибке `attachment.not.ready`
- Явная валидация ID получателя: `0` отклоняется с подсказкой по полям из `Max Trigger`
- Интерактивные клавиатуры с кнопками

### Чаты

- Получение информации о чате
- Выход из групповых чатов

### Триггер

- Получение событий в реальном времени:
  - Новые сообщения в личных диалогах (`message_created`) и чатах (`message_chat_created`)
  - Нажатия на кнопки
  - События чатов
- Поддержка webhook URL с интернационализированными доменами (IDN/Punycode) для корректной TLS-валидации

## Настройка

1. Создайте бота через @PrimeBot в Max мессенджере
2. Получите токен доступа
3. Добавьте токен в настройки ноды в n8n

## Быстрый старт

### Отправка сообщения

1. Добавьте ноду Max в workflow
2. Выберите операцию "Send Message"
3. Укажите ID получателя; при необходимости добавьте текст
4. Чтобы отправить только файл/медиа, оставьте `Message Text` пустым и добавьте вложение в `Additional Fields → Attachments`
5. Запустите workflow

### Получение сообщений

1. Добавьте ноду Max Trigger
2. Настройте webhook
3. Выберите типы событий для отслеживания

## Ресурсы

- [Документация Max Bot API](https://dev.max.ru/docs-api)
- [GitHub репозиторий](https://github.com/pfrankov/n8n-nodes-max)

## Лицензия

[MIT](LICENSE.md)
